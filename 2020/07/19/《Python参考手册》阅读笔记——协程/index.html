<!DOCTYPE html><html lang="zh-Hans"><head><meta charset="utf-8"><meta name="X-UA-Compatible" content="IE=edge"><title> 《Python参考手册》阅读笔记——协程 · Lucky4</title><meta name="description" content="《Python参考手册》阅读笔记——协程 - Lucky4"><meta name="viewport" content="width=device-width, initial-scale=1"><link rel="icon" href="/favicon.png"><link rel="stylesheet" href="/css/apollo.css"><link rel="search" type="application/opensearchdescription+xml" href="http://yoursite.com/atom.xml" title="Lucky4"></head><body><div class="wrap"><header><a href="/" class="logo-link"><img src="/favicon.png" alt="logo"></a><ul class="nav nav-list"><li class="nav-list-item"><a href="/" target="_self" class="nav-list-link">BLOG</a></li><li class="nav-list-item"><a href="/archives/" target="_self" class="nav-list-link">ARCHIVE</a></li><li class="nav-list-item"><a href="http://weibo.com/sunchongsheng" target="_blank" class="nav-list-link">WEIBO</a></li><li class="nav-list-item"><a href="https://github.com/pinggod" target="_blank" class="nav-list-link">GITHUB</a></li><li class="nav-list-item"><a href="/atom.xml" target="_self" class="nav-list-link">RSS</a></li></ul></header><main class="container"><div class="post"><article class="post-block"><h1 class="post-title">《Python参考手册》阅读笔记——协程</h1><div class="post-info">Jul 19, 2020</div><div class="post-content"><p>目录：</p>
<ul>
<li><a href="#1-前言">1 前言</a></li>
<li><a href="#2-生成器">2 生成器</a><ul>
<li><a href="#yield-语句">yield 语句</a></li>
<li><a href="#生成器">生成器</a></li>
</ul>
</li>
<li><a href="#3-协程">3 协程</a></li>
<li><a href="#4-基于任务调度程序">4 基于任务调度程序</a></li>
</ul>
<h2 id="1-前言"><a href="#1-前言" class="headerlink" title="1 前言"></a>1 前言</h2><p><code>协程</code> 是 Python 的语言特性中一个很重要的部分，学习要抓住重点，因此，很有必要了解一下。</p>
<p><br></p>
<h2 id="2-生成器"><a href="#2-生成器" class="headerlink" title="2 生成器"></a>2 生成器</h2><p>了解协程之前，先熟悉一下<code>生成器</code>的概念。</p>
<h4 id="yield-语句"><a href="#yield-语句" class="headerlink" title="yield 语句"></a>yield 语句</h4><p>使用 <code>yield</code> 语句，可以定义生成器对象，让函数生成一个结果序列，以便在迭代中使用。</p>
<figure class="highlight py"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div></pre></td><td class="code"><pre><div class="line"><span class="function"><span class="keyword">def</span> <span class="title">countdown</span><span class="params">(n)</span>:</span></div><div class="line">    <span class="keyword">while</span> n &gt; <span class="number">0</span>:</div><div class="line">        <span class="keyword">yield</span> n</div><div class="line">        n -= <span class="number">1</span></div></pre></td></tr></table></figure>
<h4 id="生成器"><a href="#生成器" class="headerlink" title="生成器"></a>生成器</h4><p>任何使用 yield 的关键字函数都称为 <code>生成器</code> 调用生成器将创建一个对象，并通过调用 <code>next()</code> 方法生成序列。</p>
<figure class="highlight py"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div></pre></td><td class="code"><pre><div class="line"><span class="meta">&gt;&gt;&gt; </span>c = countdoen(<span class="number">5</span>)</div><div class="line"><span class="meta">&gt;&gt;&gt; </span>c.next()</div><div class="line"><span class="meta">&gt;&gt;&gt; </span><span class="number">5</span></div><div class="line"><span class="meta">&gt;&gt;&gt; </span>c.next</div><div class="line"><span class="meta">&gt;&gt;&gt; </span><span class="number">4</span></div></pre></td></tr></table></figure>
<p>next() 调用生成器函数一直运行到下一条 yield 语句为止，此时 next() 将返回值传递给 yield ，函数终止执行。</p>
<p>通常使用 for 循环的方式生成值：<br><figure class="highlight py"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div></pre></td><td class="code"><pre><div class="line"><span class="meta">&gt;&gt;&gt; </span><span class="keyword">for</span> i <span class="keyword">in</span> countdown(<span class="number">5</span>):</div><div class="line">        <span class="keyword">print</span> i</div><div class="line"></div><div class="line"><span class="number">5</span> <span class="number">4</span> <span class="number">3</span> <span class="number">2</span> <span class="number">1</span></div><div class="line">&gt;&gt;&gt;</div></pre></td></tr></table></figure></p>
<p>异常：</p>
<ul>
<li>StopIteration 异常</li>
<li>GeneratorExit 异常</li>
</ul>
<p>决不能通过单独的线程或信号处理程序在该生成器上异步地调用 close() 方法。</p>
<p>通过调用 <code>close()</code> 方法关闭生成器对象。<br><figure class="highlight py"><table><tr><td class="gutter"><pre><div class="line">1</div></pre></td><td class="code"><pre><div class="line"><span class="meta">&gt;&gt;&gt; </span>c.close()</div></pre></td></tr></table></figure></p>
<h2 id="3-协程"><a href="#3-协程" class="headerlink" title="3 协程"></a>3 协程</h2><p>通常，函数运行时要输入一组参数，但是也可以把函数编写为一个任务，从而能处理发送给它的一系列输入，这类函数称为 <code>协程</code> 。可使用 <code>(yield)</code> 的形式创建协程。如下所示：</p>
<figure class="highlight py"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div></pre></td><td class="code"><pre><div class="line"><span class="function"><span class="keyword">def</span> <span class="title">print_matches</span><span class="params">(matchtext)</span>:</span></div><div class="line">    <span class="keyword">while</span> <span class="keyword">True</span>:</div><div class="line">        line = (<span class="keyword">yield</span>)</div><div class="line">        <span class="keyword">if</span> matchtext <span class="keyword">in</span> line:</div><div class="line">            <span class="keyword">print</span> line</div></pre></td></tr></table></figure>
<p>调用：<br><figure class="highlight py"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div></pre></td><td class="code"><pre><div class="line"><span class="meta">&gt;&gt;&gt; </span>matcher = print_matches(<span class="string">"python"</span>)</div><div class="line"><span class="meta">&gt;&gt;&gt; </span>matcher.next()</div><div class="line"><span class="meta">&gt;&gt;&gt; </span>matcher.send(<span class="string">"Hello World"</span>)</div><div class="line"><span class="meta">&gt;&gt;&gt; </span>matcher.send(<span class="string">"Python is cool"</span>)</div><div class="line">python <span class="keyword">is</span> cool</div><div class="line"><span class="meta">&gt;&gt;&gt; </span>matcher.close()</div></pre></td></tr></table></figure></p>
<p>其中 matcher.next() 用来执行到 (yield) 之前，协程终止。使用 matcher.send() 为协程发送值，(yield) 表达式返回这个值，并执行下面的语句，直至再次遇到 (yield) 语句。</p>
<p>协程的运行一般是无期限的，除非它被显式的关闭或自己退出。使用 close() 方法可以关闭输入值的流。</p>
<p>协程可用于实现某种形式的并发，例如，安排一个集中式的任务管理器或时间循环，将数据发送到成百上千个用于执行任务的协程中，输入数据到协程中。协程经常可以和使用消息队列的程序一起使用。</p>
<p><br></p>
<h2 id="4-基于任务调度程序"><a href="#4-基于任务调度程序" class="headerlink" title="4 基于任务调度程序"></a>4 基于任务调度程序</h2><p>select 模块可以用来实现基于小任务（greenlet）或协程的服务器，下面是一个使用协程实现的基于 I/O 的任务调度程度，其中借助了 select 模块进行循环获取 I/O。<br><figure class="highlight py"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div><div class="line">15</div><div class="line">16</div><div class="line">17</div><div class="line">18</div><div class="line">19</div><div class="line">20</div><div class="line">21</div><div class="line">22</div><div class="line">23</div><div class="line">24</div><div class="line">25</div><div class="line">26</div><div class="line">27</div><div class="line">28</div><div class="line">29</div><div class="line">30</div><div class="line">31</div><div class="line">32</div><div class="line">33</div><div class="line">34</div><div class="line">35</div><div class="line">36</div><div class="line">37</div><div class="line">38</div><div class="line">39</div><div class="line">40</div><div class="line">41</div><div class="line">42</div><div class="line">43</div><div class="line">44</div><div class="line">45</div><div class="line">46</div><div class="line">47</div><div class="line">48</div><div class="line">49</div><div class="line">50</div><div class="line">51</div><div class="line">52</div><div class="line">53</div><div class="line">54</div><div class="line">55</div><div class="line">56</div><div class="line">57</div><div class="line">58</div><div class="line">59</div><div class="line">60</div><div class="line">61</div><div class="line">62</div><div class="line">63</div><div class="line">64</div><div class="line">65</div><div class="line">66</div><div class="line">67</div><div class="line">68</div><div class="line">69</div><div class="line">70</div><div class="line">71</div><div class="line">72</div><div class="line">73</div><div class="line">74</div><div class="line">75</div><div class="line">76</div><div class="line">77</div><div class="line">78</div><div class="line">79</div><div class="line">80</div><div class="line">81</div><div class="line">82</div><div class="line">83</div><div class="line">84</div><div class="line">85</div><div class="line">86</div><div class="line">87</div><div class="line">88</div><div class="line">89</div><div class="line">90</div><div class="line">91</div><div class="line">92</div><div class="line">93</div><div class="line">94</div><div class="line">95</div><div class="line">96</div><div class="line">97</div><div class="line">98</div><div class="line">99</div><div class="line">100</div><div class="line">101</div><div class="line">102</div><div class="line">103</div><div class="line">104</div><div class="line">105</div><div class="line">106</div><div class="line">107</div><div class="line">108</div><div class="line">109</div><div class="line">110</div><div class="line">111</div><div class="line">112</div><div class="line">113</div><div class="line">114</div><div class="line">115</div><div class="line">116</div><div class="line">117</div><div class="line">118</div><div class="line">119</div><div class="line">120</div><div class="line">121</div><div class="line">122</div><div class="line">123</div><div class="line">124</div><div class="line">125</div><div class="line">126</div><div class="line">127</div><div class="line">128</div><div class="line">129</div><div class="line">130</div><div class="line">131</div><div class="line">132</div><div class="line">133</div><div class="line">134</div><div class="line">135</div></pre></td><td class="code"><pre><div class="line"><span class="keyword">import</span> collections</div><div class="line"><span class="keyword">import</span> select</div><div class="line"><span class="keyword">import</span> types</div><div class="line"></div><div class="line"></div><div class="line"><span class="class"><span class="keyword">class</span> <span class="title">Task</span><span class="params">(object)</span>:</span></div><div class="line">    <span class="string">"""</span></div><div class="line">    表示运行任务的对象</div><div class="line">    """</div><div class="line">    <span class="function"><span class="keyword">def</span> <span class="title">__init</span><span class="params">(self, target)</span>:</span></div><div class="line">        self.target = target</div><div class="line">        self.sendval = <span class="keyword">None</span></div><div class="line">        self.stack = []</div><div class="line">    </div><div class="line">    <span class="function"><span class="keyword">def</span> <span class="title">run</span><span class="params">(self)</span>:</span></div><div class="line">        <span class="keyword">try</span>:</div><div class="line">            result = self.target.send(self.sendval)</div><div class="line">            <span class="keyword">if</span> isinstance(result, SystemCall):</div><div class="line">                <span class="keyword">return</span> result</div><div class="line">            <span class="keyword">if</span> isinstance(result, types.GeneratorType):</div><div class="line">                self.stack.append(self.target)</div><div class="line">                self.sendval = <span class="keyword">None</span></div><div class="line">                self.target = result</div><div class="line">            <span class="keyword">else</span>:</div><div class="line">                <span class="keyword">if</span> <span class="keyword">not</span> self.stack:</div><div class="line">                    <span class="keyword">return</span></div><div class="line">                self.sendval = result</div><div class="line">                self.target = self.stack.pop()</div><div class="line">        <span class="keyword">except</span> StopIteration:</div><div class="line">            <span class="keyword">if</span> <span class="keyword">not</span> self.stack:</div><div class="line">                <span class="keyword">raise</span></div><div class="line">            self.sendval = <span class="keyword">None</span></div><div class="line">            self.target = self.stack.pop()</div><div class="line"></div><div class="line"></div><div class="line"><span class="class"><span class="keyword">class</span> <span class="title">SystemCall</span><span class="params">(object)</span>:</span></div><div class="line">    <span class="string">"""</span></div><div class="line">    表示“系统调用”的对象</div><div class="line">    """</div><div class="line">    <span class="function"><span class="keyword">def</span> <span class="title">handle</span><span class="params">(self, sched, task)</span>:</span></div><div class="line">        <span class="keyword">pass</span></div><div class="line"></div><div class="line"></div><div class="line"><span class="class"><span class="keyword">class</span> <span class="title">ReadWait</span><span class="params">(SystemCall)</span>:</span></div><div class="line">    <span class="function"><span class="keyword">def</span> <span class="title">__init__</span><span class="params">(self, f)</span>:</span></div><div class="line">        self.f = f</div><div class="line">    </div><div class="line">    <span class="function"><span class="keyword">def</span> <span class="title">handle</span><span class="params">(self, sched, task)</span>:</span></div><div class="line">        fileno = self.f.fileno()</div><div class="line">        sched.readwait(task, fileno)</div><div class="line"></div><div class="line"></div><div class="line"><span class="class"><span class="keyword">class</span> <span class="title">WriteWait</span><span class="params">(SystemCall)</span>:</span></div><div class="line">    <span class="function"><span class="keyword">def</span> <span class="title">__init__</span><span class="params">(self, f)</span>:</span></div><div class="line">        self.f = f</div><div class="line"></div><div class="line">    <span class="function"><span class="keyword">def</span> <span class="title">handle</span><span class="params">(self, sched, task)</span>:</span></div><div class="line">        fileno = self.f.fileno()</div><div class="line">        sched.writewait(task, fileno)</div><div class="line"></div><div class="line"></div><div class="line"><span class="class"><span class="keyword">class</span> <span class="title">NewTask</span><span class="params">(SystemCall)</span>:</span></div><div class="line">    <span class="function"><span class="keyword">def</span> <span class="title">__init__</span><span class="params">(self, target)</span>:</span></div><div class="line">        self.target = target</div><div class="line"></div><div class="line">    <span class="function"><span class="keyword">def</span> <span class="title">handle</span><span class="params">(self, sched, target)</span>:</span></div><div class="line">        sched.new(self.target)</div><div class="line">        sched.schedule(task)</div><div class="line"></div><div class="line"></div><div class="line"><span class="class"><span class="keyword">class</span> <span class="title">Scheduler</span><span class="params">(object)</span>:</span></div><div class="line">    <span class="string">"""</span></div><div class="line">    调度程序对象</div><div class="line">    """</div><div class="line">    <span class="function"><span class="keyword">def</span> <span class="title">__init__</span><span class="params">(self)</span>:</span></div><div class="line">        self.task_queue = collections.deque()</div><div class="line">        self.read_waiting = &#123;&#125;</div><div class="line">        self.write_waiting = &#123;&#125;</div><div class="line">        self.numtasks = <span class="number">0</span></div><div class="line"></div><div class="line">    <span class="function"><span class="keyword">def</span> <span class="title">schedule</span><span class="params">(self, task)</span>:</span></div><div class="line">        <span class="string">"""</span></div><div class="line">        将任务放入任务调度队列</div><div class="line">        """</div><div class="line">        self.task_queue.append(task)</div><div class="line"></div><div class="line">    <span class="function"><span class="keyword">def</span> <span class="title">new</span><span class="params">(self, target)</span>:</span></div><div class="line">        <span class="string">"""</span></div><div class="line">        通过协程新建任务</div><div class="line">        """</div><div class="line">        newtask = Task(target)</div><div class="line">        self.schedule(newtask)</div><div class="line">        self.numtasks += <span class="number">1</span></div><div class="line"></div><div class="line">    <span class="function"><span class="keyword">def</span> <span class="title">readwait</span><span class="params">(self, task, fd)</span>:</span></div><div class="line">        <span class="string">"""</span></div><div class="line">        让任务等待文件描述符上的数据</div><div class="line">        """</div><div class="line">        self.read_waiting[fd] = task</div><div class="line"></div><div class="line">    <span class="function"><span class="keyword">def</span> <span class="title">writewait</span><span class="params">(self, task, fd)</span>:</span></div><div class="line">        <span class="string">"""</span></div><div class="line">        让任务等待写入文件描述符</div><div class="line">        """</div><div class="line">        self.write_waiting[fd] = task</div><div class="line">    </div><div class="line">    <span class="function"><span class="keyword">def</span> <span class="title">mainloop</span><span class="params">(self, count=<span class="number">-1</span>, timeout=None)</span>:</span></div><div class="line">        <span class="string">"""</span></div><div class="line">        调度程序主循环</div><div class="line">        """</div><div class="line">        <span class="keyword">while</span> self.numtasks:</div><div class="line">            <span class="keyword">if</span> self.read_waiting <span class="keyword">or</span> self.write_waiting:</div><div class="line">                wait = <span class="number">0</span> <span class="keyword">if</span> self.task_queue <span class="keyword">else</span> timeout</div><div class="line">                r, w, e = select.select(self.read_waiting, self.write_waiting, [],</div><div class="line">                                        wait)</div><div class="line">                <span class="keyword">for</span> fileno <span class="keyword">in</span> r:</div><div class="line">                    self.schedule(self.read_waiting.pop(fileno))</div><div class="line">                <span class="keyword">for</span> fileno <span class="keyword">in</span> w:</div><div class="line">                    self.schedule(self.write_waiting.pop(fileno))</div><div class="line"></div><div class="line">            <span class="keyword">while</span> self.task_queue:</div><div class="line">                task = self.task_queue.popleft()</div><div class="line">                <span class="keyword">try</span>:</div><div class="line">                    result = task.run()</div><div class="line">                    <span class="keyword">if</span> isinstance(result, SystemCall):</div><div class="line">                        result.handle(self, task)</div><div class="line">                    <span class="keyword">else</span>:</div><div class="line">                        self.schedule(task)</div><div class="line">                <span class="keyword">except</span> StopIteration:</div><div class="line">                    self.numtasks -= <span class="number">1</span></div><div class="line">            </div><div class="line">            <span class="keyword">if</span> count &gt; <span class="number">0</span>:</div><div class="line">                count -= <span class="number">1</span></div><div class="line">            <span class="keyword">if</span> count == <span class="number">0</span>:</div><div class="line">                <span class="keyword">return</span></div></pre></td></tr></table></figure></p>
<p>使用这种 I/O 任务调度程序实现的网络时间服务器示例<br><figure class="highlight py"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div><div class="line">15</div><div class="line">16</div><div class="line">17</div><div class="line">18</div><div class="line">19</div><div class="line">20</div><div class="line">21</div><div class="line">22</div><div class="line">23</div></pre></td><td class="code"><pre><div class="line"><span class="keyword">from</span> socket <span class="keyword">import</span> socket, AF_INET, SOCK_STREAM</div><div class="line"></div><div class="line"></div><div class="line"><span class="function"><span class="keyword">def</span> <span class="title">time_server</span><span class="params">(address)</span>:</span></div><div class="line">    <span class="keyword">import</span> time</div><div class="line">    </div><div class="line">    s = socket(AF_INET, SOCK_STREAM)</div><div class="line">    s.bind(address)</div><div class="line">    s.listen(<span class="number">5</span>)</div><div class="line">    <span class="keyword">while</span> <span class="keyword">True</span>:</div><div class="line">        <span class="keyword">yield</span> ReadWait(s)</div><div class="line">        conn, addr = s.accept()</div><div class="line">        <span class="keyword">print</span> <span class="string">"Connection from %s"</span> % str(addr)</div><div class="line">        <span class="keyword">yield</span> WriteWait(conn)</div><div class="line">        resp = time.ctime() + <span class="string">"\r\n"</span></div><div class="line">        conn.send(resp.encode(<span class="string">'latin-1'</span>))</div><div class="line">        conn.close()</div><div class="line"></div><div class="line"></div><div class="line">sched = Scheduler()</div><div class="line">sched.new(time_server((<span class="string">''</span>, <span class="number">10000</span>))) <span class="comment"># 10000端口上的服务器</span></div><div class="line">sched.new(time_server((<span class="string">''</span>, <span class="number">11000</span>))) <span class="comment"># 11000端口上的服务器</span></div><div class="line">sched.run()</div></pre></td></tr></table></figure></p>
<p><br></p>
<h2 id="参考"><a href="#参考" class="headerlink" title="参考"></a>参考</h2><p>《Python参考手册》</p>
</div></article></div></main><footer><div class="paginator"><a href="/2020/08/08/《高性能的MySQL》阅读笔记——创建高性能的索引/" class="prev">PREV</a><a href="/2020/07/19/《大型网站技术架构——核心原理与案例分析》阅读笔记/" class="next">NEXT</a></div><div class="copyright"><p>© 2015 - 2020 <a href="http://yoursite.com">Lucky4</a>, powered by <a href="https://hexo.io/" target="_blank">Hexo</a> and <a href="https://github.com/pinggod/hexo-theme-apollo" target="_blank">hexo-theme-apollo</a>.</p></div></footer></div><script async src="//cdn.bootcss.com/mathjax/2.7.0/MathJax.js?config=TeX-MML-AM_CHTML" integrity="sha384-crwIf/BuaWM9rM65iM+dWFldgQ1Un8jWZMuh3puxb8TOY9+linwLoI7ZHZT+aekW" crossorigin="anonymous"></script><script>(function(b,o,i,l,e,r){b.GoogleAnalyticsObject=l;b[l]||(b[l]=function(){(b[l].q=b[l].q||[]).push(arguments)});b[l].l=+new Date;e=o.createElement(i);r=o.getElementsByTagName(i)[0];e.src='//www.google-analytics.com/analytics.js';r.parentNode.insertBefore(e,r)}(window,document,'script','ga'));ga('create',"UA-65933410-1",'auto');ga('send','pageview');</script></body></html>